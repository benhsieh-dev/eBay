# GitLab CI/CD Pipeline for eBay Marketplace
# Deploys Spring Boot application to AWS Elastic Beanstalk

image: ubuntu:22.04

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"

cache:
  paths:
    - .m2/repository/
    - frontend/node_modules/

stages:
  - build
  - test
  - package
  - deploy

before_script:
  - apt-get update -qq && apt-get install -y -qq git curl python3 python3-pip openjdk-17-jdk maven unzip
  - export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
  # Install Node.js 18
  - curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
  - apt-get install -y nodejs
  # Verify installations
  - java -version
  - mvn --version
  - node --version
  - npm --version
  # Install AWS CLI and EB CLI
  - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
  - unzip awscliv2.zip
  - ./aws/install
  - pip3 install awsebcli

build:
  stage: build
  script:
    - echo "Building Spring Boot application with frontend..."
    - mvn clean compile
  artifacts:
    paths:
      - target/classes/
    expire_in: 1 hour

test:
  stage: test
  script:
    - echo "Running unit tests..."
    - mvn test
  artifacts:
    reports:
      junit: target/surefire-reports/TEST-*.xml
    paths:
      - target/surefire-reports/
  coverage: '/Total.*?([0-9]{1,3})%/'

package:
  stage: package
  script:
    - echo "Packaging application JAR with frontend..."
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 day
  only:
    - master

deploy_to_aws:
  stage: deploy
  timeout: 15m
  script:
    - echo "Deploying to AWS Elastic Beanstalk..."
    # Ensure JAR file exists - rebuild if necessary
    - |
      if [ ! -f target/ebay-0.0.1-SNAPSHOT.jar ]; then
        echo "JAR file not found, building application..."
        mvn clean package -DskipTests
      fi
    - ls -la target/
    - echo "Checking current EB environment variables..."
    - eb printenv ebay-medium || echo "Could not retrieve environment variables"
    # Quick JAR file verification
    - echo "JAR file size:" && ls -lh target/ebay-0.0.1-SNAPSHOT.jar
    - eb --version
    - eb deploy ebay-medium
    - echo "Deployment completed, checking application health..."
    - eb health ebay-medium || echo "Could not retrieve health status"
  environment:
    name: production
    url: https://ebay-medium.eba-e3jvit9g.us-east-2.elasticbeanstalk.com
  only:
    - master
  when: manual  # Require manual approval for production deployment
  allow_failure: false